name: Test and Split

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        php-version: ['8.4']
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php-version }}
          extensions: pdo, pdo_sqlite, pdo_mysql
          coverage: none
      
      - name: Validate composer.json
        run: composer validate --strict
      
      - name: Cache Composer packages
        uses: actions/cache@v3
        with:
          path: vendor
          key: ${{ runner.os }}-php-${{ matrix.php-version }}-${{ hashFiles('**/composer.lock') }}
          restore-keys: |
            ${{ runner.os }}-php-${{ matrix.php-version }}-
      
      - name: Install dependencies
        run: composer install --prefer-dist --no-progress
      
      - name: Run PHPUnit tests
        run: composer test

  split:
    name: Split Monorepo
    needs: test
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        package:
          - { name: 'Aspects', repo: 'aql-aspects' }
          - { name: 'Dsl', repo: 'aql-dsl' }
          - { name: 'DTO', repo: 'aql-dto' }
          - { name: 'Entity', repo: 'aql-entity' }
          - { name: 'Executor', repo: 'aql-executor' }
          - { name: 'FileSystem', repo: 'aql-filesystem' }
          - { name: 'Generator', repo: 'aql-generator' }
          - { name: 'Mysql', repo: 'aql-mysql' }
          - { name: 'PdoDriver', repo: 'aql-pdodriver' }
          - { name: 'PostAction', repo: 'aql-postaction' }
          - { name: 'PostgreSql', repo: 'aql-postgresql' }
          - { name: 'Redis', repo: 'aql-redis' }
          - { name: 'Result', repo: 'aql-result' }
          - { name: 'SqlDriver', repo: 'aql-sqldriver' }
          - { name: 'SQLite', repo: 'aql-sqlite' }
          - { name: 'Storage', repo: 'aql-storage' }
          - { name: 'StoragePool', repo: 'aql-storagepool' }
          - { name: 'Telemetry', repo: 'aql-telemetry' }
          - { name: 'TestUtils', repo: 'aql-test-utils' }
          - { name: 'Transaction', repo: 'aql-transaction' }
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Split ${{ matrix.package.name }}
        uses: symplify/monorepo-split-github-action@v2.3.0
        with:
          package_directory: 'src/${{ matrix.package.name }}'
          repository_organization: 'AbstractQueryLayer'
          repository_name: ${{ matrix.package.repo }}
          user_name: "github-actions[bot]"
          user_email: "github-actions[bot]@users.noreply.github.com"
          branch: 'main'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
